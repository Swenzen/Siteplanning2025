<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base de Donnée</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="content">
        <h1>Base de Donnée</h1>
        
        <!-- Tableau des noms -->
        <h2>Noms</h2>
        <table id="databaseTable">
            <thead>
                <tr>
                    <th>nom_id</th>
                    <th>nom</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Les lignes seront ajoutées ici dynamiquement -->
            </tbody>
        </table>
        <button id="addNameButton">Ajouter un nom</button>

        <!-- Tableau des compétences -->
        <h2>Compétences</h2>
        <table id="competencesTable">
            <thead>
                <tr>
                    <th>Compétence</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Les lignes seront ajoutées ici dynamiquement -->
            </tbody>
        </table>
        <button id="addCompetenceButton">Ajouter une compétence</button>


        <!-- Tableau des horaires -->
        <h2>Horaires</h2>
        <table id="horairesTable">
            <thead>
                <tr>
                    <th>Horaire début</th>
                    <th>Horaire fin</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                        <!-- Les lignes seront ajoutées ici dynamiquement -->
            </tbody>
        </table>
        <button id="addHoraireButton">Ajouter un horaire</button>

        <!-- Tableau des compétences des personnes -->
        <h2>Compétences des personnes</h2>
        <table id="competencesPersonnesTable">
            <thead>
                <tr>
                    <th>Nom</th>
                    <!-- Les compétences seront ajoutées ici dynamiquement -->
                </tr>
            </thead>
            <tbody>
                <!-- Les lignes seront ajoutées ici dynamiquement -->
            </tbody>
        </table>
    </div>
    
    <div id="menu">
        <h2>Menu</h2>
        <a href="index.html">Index</a>
        <a href="base-de-donnee.html">Base de donnée</a>
        <a href="planning.html">Planning</a>
    </div>
    
    <!-- Fenêtre modale -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Modifier le nom</h2>
            <input type="text" id="newName" placeholder="Entrez le nouveau nom">
            <button id="saveName">Sauvegarder</button>
        </div>
    </div>
    
    <script>
        let currentCell = null;
        let currentId = null;

        // TODO: Section pour le tableau des noms
        // Fonction pour afficher les données dans le tableau des noms
        async function fetchData() {
            try {
                console.time('fetchData');
                const response = await fetch('/api/data');
                const data = await response.json();
                
                const tableBody = document.querySelector("#databaseTable tbody");
                tableBody.innerHTML = ''; // Vider le contenu du tableau

                // Créer un fragment de document pour minimiser les manipulations du DOM
                const fragment = document.createDocumentFragment();

                // Ajouter les données récupérées au tableau
                data.forEach(rowData => {
                    const row = document.createElement("tr");
                    Object.keys(rowData).forEach(key => {
                        const cell = document.createElement("td");
                        cell.textContent = rowData[key];
                        // Ajouter un gestionnaire de clics à la colonne "nom"
                        if (key === 'nom') {
                            cell.style.cursor = 'pointer';
                            cell.addEventListener("click", () => {
                                currentCell = cell;
                                currentId = rowData.nom_id;
                                showModal();
                            });
                        }
                        row.appendChild(cell);
                    });
                    // Ajouter une cellule pour les actions (supprimer)
                    const actionCell = document.createElement("td");
                    const deleteButton = document.createElement("button");
                    deleteButton.textContent = "Supprimer";
                    deleteButton.addEventListener("click", () => deleteName(rowData.nom_id));
                    actionCell.appendChild(deleteButton);
                    row.appendChild(actionCell);
                    fragment.appendChild(row);
                });

                tableBody.appendChild(fragment); // Ajouter le fragment au DOM en une seule opération
                console.timeEnd('fetchData');

                // Appel de la fonction pour récupérer les compétences des personnes
                fetchCompetencesPersonnes();
                // Appel de la fonction pour récupérer les compétences
                fetchCompetences();
            } catch (error) {
                console.error('Erreur lors de la récupération des données :', error);
            }
        }

        // Fonction pour ajouter un nom
        async function addName() {
            const nom = prompt("Entrez le nom");
            if (nom) {
                try {
                    console.time('addName');
                    const response = await fetch('/api/add-nom', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ nom })
                    });

                    if (response.ok) {
                        fetchData();
                    } else {
                        console.error('Erreur lors de l\'ajout du nom');
                    }
                    console.timeEnd('addName');
                } catch (error) {
                    console.error('Erreur lors de la requête:', error);
                }
            }
        }

        // Fonction pour supprimer un nom
        async function deleteName(nom_id) {
            if (confirm("Êtes-vous sûr de vouloir supprimer ce nom ?")) {
                try {
                    console.time('deleteName');
                    console.log(`Suppression du nom avec nom_id: ${nom_id}`); // Ajout d'un message de console
                    const response = await fetch('/api/delete-nom', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ nom_id })
                    });

                    if (response.ok) {
                        console.log('Nom supprimé avec succès'); // Ajout d'un message de console
                        fetchData();
                    } else {
                        console.error('Erreur lors de la suppression du nom');
                    }
                    console.timeEnd('deleteName');
                } catch (error) {
                    console.error('Erreur lors de la requête:', error);
                }
            }
        }

        // Fonction pour afficher la fenêtre modale
        function showModal() {
            const modal = document.getElementById("myModal");
            modal.style.display = "block";
            document.getElementById("newName").value = currentCell.textContent;
        }

        // Fonction pour fermer la fenêtre modale
        function closeModal() {
            const modal = document.getElementById("myModal");
            modal.style.display = "none";
        }

        // Fonction pour sauvegarder le nouveau nom
        async function saveName() {
            const newName = document.getElementById("newName").value;
            if (currentCell && currentId) {
                try {
                    console.time('saveName');
                    const response = await fetch('/api/update-name', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ nom_id: currentId, nom: newName })
                    });

                    if (response.ok) {
                        const result = await response.text();
                        console.log(result);
                        // Mettre à jour l'affichage du nom dans la cellule
                        currentCell.textContent = newName;
                        closeModal();
                    } else {
                        console.error('Erreur lors de la mise à jour du nom');
                    }
                    console.timeEnd('saveName');
                } catch (error) {
                    console.error('Erreur lors de la requête:', error);
                }
            }
        }

        // Gestionnaire d'événements pour fermer la fenêtre modale
        document.querySelector(".close").addEventListener("click", closeModal);

        // Gestionnaire d'événements pour sauvegarder le nouveau nom
        document.getElementById("saveName").addEventListener("click", saveName);

        // Gestionnaire d'événements pour ajouter un nom
        document.getElementById("addNameButton").addEventListener("click", addName);

        // Appeler la fonction pour récupérer les données lorsque la page est chargée
        document.addEventListener('DOMContentLoaded', fetchData);

        // Fermer la fenêtre modale si l'utilisateur clique en dehors de celle-ci
        window.onclick = function(event) {
            const modal = document.getElementById("myModal");
            if (event.target === modal) {
                modal.style.display = "none";
            }
        }

        
        // TODO: Section pour le tableau des compétences
        // Fonction pour afficher les compétences dans le tableau
        async function fetchCompetences() {
            try {
                console.time('fetchCompetences');
                const response = await fetch('/api/competences');
                const data = await response.json();
                
                const tableBody = document.querySelector("#competencesTable tbody");
                tableBody.innerHTML = ''; // Vider le contenu du tableau

                // Créer un fragment de document pour minimiser les manipulations du DOM
                const fragment = document.createDocumentFragment();

                // Ajouter les données récupérées au tableau
                data.forEach(rowData => {
                    const row = document.createElement("tr");
                    const competenceCell = document.createElement("td");
                    competenceCell.textContent = rowData.competence;
                    row.appendChild(competenceCell);

                    // Ajouter une cellule pour les actions (supprimer)
                    const actionCell = document.createElement("td");
                    const deleteButton = document.createElement("button");
                    deleteButton.textContent = "Supprimer";
                    deleteButton.dataset.competenceId = rowData.competence_id; // Utiliser dataset pour stocker l'ID
                    actionCell.appendChild(deleteButton);
                    row.appendChild(actionCell);

                    fragment.appendChild(row);
                });

                tableBody.appendChild(fragment); // Ajouter le fragment au DOM en une seule opération
                console.timeEnd('fetchCompetences');
            } catch (error) {
                console.error('Erreur lors de la récupération des compétences :', error);
            }
        }

        // Fonction pour ajouter une compétence
        async function addCompetence() {
            const competence = prompt("Entrez la compétence");
            if (competence) {
                try {
                    console.time('addCompetence');
                    const response = await fetch('/api/add-competence2', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ competence })
                    });

                    if (response.ok) {
                        fetchCompetences();
                    } else {
                        console.error('Erreur lors de l\'ajout de la compétence');
                    }
                    console.timeEnd('addCompetence');
                } catch (error) {
                    console.error('Erreur lors de la requête:', error);
                }
            }
        }

        // Fonction pour supprimer une compétence
        async function deleteCompetence(competence_id) {
            if (confirm("Êtes-vous sûr de vouloir supprimer cette compétence ?")) {
                try {
                    console.time('deleteCompetence');
                    const response = await fetch('/api/delete-competence', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ competence_id })
                    });

                    if (response.ok) {
                        fetchCompetences();
                    } else {
                        console.error('Erreur lors de la suppression de la compétence');
                    }
                    console.timeEnd('deleteCompetence');
                } catch (error) {
                    console.error('Erreur lors de la requête:', error);
                }
            }
        }

        // Utiliser la délégation d'événements pour gérer les clics sur les boutons de suppression
        document.querySelector("#competencesTable tbody").addEventListener("click", (event) => {
            if (event.target.tagName === "BUTTON" && event.target.textContent === "Supprimer") {
                const competenceId = event.target.dataset.competenceId;
                deleteCompetence(competenceId);
            }
        });

        // Gestionnaire d'événements pour ajouter une compétence
        document.getElementById("addCompetenceButton").addEventListener("click", addCompetence);

    
    
    
    </script>

    <!-- Inclure le fichier JavaScript pour les horaires -->
    <script src="js/horaires.js"></script>
    <script src="js/competencespersonnes.js"></script>


</body>
</html>