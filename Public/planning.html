<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="content">
        <h1>Planning</h1>
        
        <!-- Champs pour le numéro de la semaine et l'année -->
        <div id="weekYearSelector">
            <label for="weekNumber">Numéro de la semaine :</label>
            <input type="number" id="weekNumber" min="1" max="52" value="1">
            <label for="yearNumber">Année :</label>
            <input type="number" id="yearNumber" value="2025">
            <button id="loadWeekButton">Charger la semaine</button>
        </div>

        <!-- Tableau pour afficher le planning -->
        <table id="planningTable">
            <thead>
                <tr>
                    <th>Compétence</th>
                    <th>Horaires</th>
                    <th>Lundi</th>
                    <th>Mardi</th>
                    <th>Mercredi</th>
                    <th>Jeudi</th>
                    <th>Vendredi</th>
                    <th>Samedi</th>
                    <th>Dimanche</th>
                </tr>
            </thead>
            <tbody>
                <!-- Les lignes seront ajoutées ici dynamiquement -->
            </tbody>
        </table>
    </div>
    
    <div id="menu">
        <h2>Menu</h2>
        <a href="index.html">Index</a>
        <a href="base-de-donnee.html">Base de donnée</a>
        <a href="planning.html">Planning</a>
    </div>
    
    <div id="tooltip"></div>
    
    <script>
        const tooltip = document.getElementById("tooltip");
        let currentCell = null;
        let currentDay = null;
        let currentHorairesNom = null;
        let currentCompetenceId = null;

        const dayMapping = {
            '1': 'lundi',
            '2': 'mardi',
            '3': 'mercredi',
            '4': 'jeudi',
            '5': 'vendredi',
            '6': 'samedi',
            '7': 'dimanche'
        };

        // Fonction pour afficher les données dans le tableau
        async function fetchPlanningData() {
            const semaine = document.getElementById("weekNumber").value;
            const annee = document.getElementById("yearNumber").value;

            try {
                const response = await fetch(`/api/planning-data?semaine=${semaine}&annee=${annee}`);
                if (!response.ok) {
                    throw new Error('Erreur lors de la récupération des données');
                }
                const data = await response.json();
                console.log('Données récupérées :', data);
                
                const tableBody = document.querySelector("#planningTable tbody");
                tableBody.innerHTML = ''; // Vider le contenu du tableau

                // Regrouper les données par compétence et horaire
                const groupedData = data.reduce((acc, row) => {
                    const key = `${row.competence}-${row.horaires_nom}`;
                    if (!acc[key]) {
                        acc[key] = { ...row, jours: {} };
                    }
                    acc[key].jours[row.jour_id] = row.nom;
                    return acc;
                }, {});

                // Ajouter les données regroupées au tableau
                Object.values(groupedData).forEach(rowData => {
                    console.log('Ajout de la ligne :', rowData);
                    const row = document.createElement("tr");
                    const modalitiesCell = document.createElement("td");
                    modalitiesCell.textContent = rowData.competence;
                    row.appendChild(modalitiesCell);

                    const horairesCell = document.createElement("td");
                    horairesCell.textContent = rowData.horaires_nom;
                    row.appendChild(horairesCell);

                    const days = ['1', '2', '3', '4', '5', '6', '7']; // Utiliser les IDs des jours
                    days.forEach(day => {
                        const cell = document.createElement("td");
                        cell.textContent = rowData.jours[day] || ''; // Afficher le nom pour chaque jour
                        cell.addEventListener('click', (event) => {
                            console.log(`Cellule cliquée : ${day}, ${rowData.competence_id}`);
                            currentCell = cell; // Stocker la cellule actuelle
                            currentDay = day;
                            currentHorairesNom = rowData.horaires_nom;
                            currentCompetenceId = rowData.competence_id;
                            fetchNomIds(rowData.competence_id, event);
                        });
                        row.appendChild(cell);
                    });

                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('Erreur lors de la récupération des données du planning :', error);
            }
        }

        // Ajouter un gestionnaire de clics au bouton pour charger la semaine
        document.getElementById("loadWeekButton").addEventListener("click", fetchPlanningData);

        // Fonction pour récupérer les noms disponibles pour une compétence donnée
        async function fetchNomIds(competenceId, event) {
            try {
                const response = await fetch(`/api/nom-ids?competence_id=${competenceId}`);
                if (!response.ok) {
                    throw new Error('Erreur lors de la récupération des noms');
                }
                const data = await response.json();
                console.log('Noms récupérés :', data);
                showTooltip(event, data);
            } catch (error) {
                console.error('Erreur lors de la récupération des noms :', error);
            }
        }

        // Fonction pour afficher le tooltip avec les noms
        function showTooltip(event, noms) {
            tooltip.innerHTML = noms.map(nom => `<div class="tooltip-date">${nom}</div>`).join('');
            tooltip.style.display = 'block';
            tooltip.style.left = `${event.pageX + 10}px`; // Slight offset for better visibility
            tooltip.style.top = `${event.pageY + 10}px`; // Slight offset for better visibility

            // Ajouter un gestionnaire de clics aux éléments de date dans le tooltip
            document.querySelectorAll('.tooltip-date').forEach(element => {
                element.addEventListener('click', function() {
                    currentCell.textContent = this.textContent; // Remplacer le contenu de la cellule
                    const semaine = document.getElementById("weekNumber").value;
                    const annee = document.getElementById("yearNumber").value;
                    const jour_id = currentDay; // Utiliser l'ID du jour
                    updatePlanning(semaine, annee, jour_id, currentHorairesNom, currentCompetenceId, this.textContent);
                    tooltip.style.display = 'none'; // Fermer le tooltip
                });
            });
        }

        // Fonction pour mettre à jour le planning dans la base de données
        async function updatePlanning(semaine, annee, jour_id, horairesNom, competenceId, nom) {
            try {
                const response = await fetch('/api/update-planning', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ semaine, annee, jour_id, horaires_nom: horairesNom, competence_id: competenceId, nom })
                });

                if (!response.ok) {
                    throw new Error('Erreur lors de la mise à jour du planning');
                }

                const result = await response.text();
                console.log(result);
            } catch (error) {
                console.error('Erreur lors de la mise à jour du planning :', error);
            }
        }

        // Cacher le tooltip lorsque l'utilisateur clique ailleurs
        document.addEventListener('click', (event) => {
            if (!event.target.closest('td') && !event.target.closest('#tooltip')) {
                tooltip.style.display = 'none';
            }
        });

        // Appeler la fonction pour récupérer les données lorsque la page est chargée
        document.addEventListener('DOMContentLoaded', fetchPlanningData);
    </script>
</body>
</html>